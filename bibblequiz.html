<script type="module">
  import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/+esm';

  const supabase = createClient(
    'https://wlthlwxcmltwescezjlk.supabase.co',
    'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6IndsdGhsd3hjbWx0d2VzY2V6amxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE0NDQ4MDcsImV4cCI6MjA2NzAyMDgwN30.tvUeTFVDdQomDHHV0JSpsXHP9IbQVkOhEvBpCglzI-o'
  );

  const { data: sessionData } = await supabase.auth.getSession();
  const session = sessionData.session;
  if (!session) window.location.href = "index.html";

  const user = session.user;
  const userId = user.id;
  const fullName = user.user_metadata.full_name || user.email;

  const allQuestions = [
    { question: "Who built the ark?", options: ["Moses", "Noah", "Abraham", "David"], answer: "Noah" },
    { question: "How many disciples did Jesus have?", options: ["10", "12", "7", "3"], answer: "12" },
    { question: "Where was Jesus born?", options: ["Nazareth", "Jerusalem", "Bethlehem", "Egypt"], answer: "Bethlehem" },
    { question: "Who was swallowed by a big fish?", options: ["Jonah", "Elijah", "Daniel", "Peter"], answer: "Jonah" },
    { question: "What is the first book of the Bible?", options: ["Exodus", "Genesis", "Leviticus", "Numbers"], answer: "Genesis" },
    { question: "Who was the strongest man in the Bible?", options: ["Samson", "David", "Goliath", "Saul"], answer: "Samson" },
    { question: "What river was Jesus baptized in?", options: ["Nile", "Jordan", "Euphrates", "Tigris"], answer: "Jordan" },
    { question: "Who led the Israelites out of Egypt?", options: ["Moses", "Aaron", "Joseph", "Joshua"], answer: "Moses" },
    { question: "How many days did Jesus fast in the wilderness?", options: ["30", "40", "50", "7"], answer: "40" },
    { question: "Who was the mother of Jesus?", options: ["Mary", "Martha", "Sarah", "Elizabeth"], answer: "Mary" },
    { question: "What is the last book of the Bible?", options: ["Revelation", "Malachi", "Acts", "Judges"], answer: "Revelation" },
    { question: "Who denied Jesus three times?", options: ["Peter", "John", "Judas", "Thomas"], answer: "Peter" },
    { question: "What is the shortest verse in the Bible?", options: ["Jesus wept", "God is love", "Love one another", "Pray always"], answer: "Jesus wept" },
    { question: "What did Jesus feed the 5,000 with?", options: ["Loaves and fishes", "Bread only", "Fish only", "Water"], answer: "Loaves and fishes" },
    { question: "What mountain did Moses receive the 10 Commandments?", options: ["Mount Sinai", "Mount Zion", "Mount Carmel", "Mount Nebo"], answer: "Mount Sinai" },
  ];

  function shuffle(array) {
    return array.sort(() => Math.random() - 0.5);
  }

  const quizData = shuffle([...allQuestions]);
  let currentQuestion = 0;
  let score = 0;

  const questionEl = document.getElementById("question");
  const optionsEl = document.getElementById("options");
  const quizBox = document.getElementById("quizBox");
  const resultBox = document.getElementById("resultBox");
  const leaderboardEl = document.getElementById("leaderboard");

  function loadQuestion() {
    const q = quizData[currentQuestion];
    questionEl.textContent = `Q${currentQuestion + 1}: ${q.question}`;
    optionsEl.innerHTML = "";
    shuffle(q.options).forEach(option => {
      const btn = document.createElement("button");
      btn.textContent = option;
      btn.className = "option-btn";
      btn.onclick = () => selectAnswer(option, q.answer);
      optionsEl.appendChild(btn);
    });
  }

  async function selectAnswer(selected, correct) {
    if (selected === correct) {
      score++;
      currentQuestion++;
      if (currentQuestion < quizData.length) {
        loadQuestion();
      } else {
        await endQuiz();
      }
    } else {
      // Wrong answer - game over
      optionsEl.innerHTML = `<p style="color:red;font-weight:bold;">Wrong! The correct answer was: ${correct}</p>`;
      setTimeout(endQuiz, 2000); // wait 2 sec then end quiz
    }
  }

  async function endQuiz() {
    quizBox.style.display = "none";
    resultBox.style.display = "block";
    document.getElementById("finalScore").textContent = `You scored ${score} out of ${quizData.length}`;

    // Check if user already exists in leaderboard
    const { data: existing } = await supabase
      .from("biblequiz_leaderboard")
      .select("id, score")
      .eq("user_id", userId)
      .maybeSingle();

    if (existing) {
      if (score > existing.score) {
        await supabase
          .from("biblequiz_leaderboard")
          .update({ score: score })
          .eq("id", existing.id);
      }
    } else {
      await supabase
        .from("biblequiz_leaderboard")
        .insert([{ user_id: userId, name: fullName, score: score }]);
    }

    const { data } = await supabase
      .from("biblequiz_leaderboard")
      .select("name, score")
      .order("score", { ascending: false })
      .limit(5);

    leaderboardEl.innerHTML = data
      .map(row => `<li><strong>${row.name}</strong>: ${row.score}</li>`)
      .join("");
  }

  loadQuestion();
</script>
